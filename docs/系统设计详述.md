# 原神伤害计算器 - 系统设计详述 (V2)

## 1. 伤害计算体系 (DamagePipeline)

### 1.1 执行阶段 (Execution Phases)
`DamagePipeline` 是战斗计算的核心驱动，分为以下严格顺序的阶段：
1.  **附魔处理 (`_handle_infusion`)**: 检查 `CombatEntity` 的 `active_effects`，根据优先级（水 > 火 > 冰 或 时间先后）决定普攻/重击/下落的元素属性。
2.  **属性快照 (`_snapshot`)**: 利用 `AttributeCalculator` 提取来源实体的即时属性（攻击、生命、精通、双暴、元素加成等），封装入 `DamageContext`。
3.  **计算前修正**: 发布 `BEFORE_CALCULATE` 事件，允许外部系统动态修改 `ctx.stats` 中的各乘区参数。
4.  **碰撞分发 (`_dispatch_broadcast`)**: 调用 `CombatSpace` 物理引擎。根据 `HitboxConfig` 进行范围检索，找到所有命中的 `CombatEntity`。
5.  **受击处理**: 被命中的实体调用 `handle_damage()`，在此阶段同步更新 ICD 和元素附着状态，并将反应结果回填至 `Damage` 对象。
6.  **反应结算**: 根据回填的 `reaction_results`，计算增幅倍率或触发剧变反应逻辑（如生成草原核）。
7.  **数值合并**: 应用防御区、抗性区、暴击区与独立乘区公式，产出最终伤害。

## 2. 空间与物理系统 (CombatSpace)

### 2.1 几何碰撞判定
所有攻击在 (X, Z) 平面上进行 2D 投影判定：
*   **圆柱 (CYLINDER)**: 最常用的判定方式，支持半径和高度过滤。
*   **长方体 (BOX)**: 支持相对攻击者朝向的长度、宽度定义。
*   **单体 (SINGLE)**: 精确锁定逻辑，但支持在 `radius > 0` 时自动退化为范围判定以提升鲁棒性。

### 2.2 位移与同步
*   **自驱动位移**: 角色执行冲刺或特定技能动作时，坐标直接在 `advance_frame` 中更新。
*   **物理分层**: 目前主要处理伤害广播判定，暂不涉及实体间的刚体挤压。

## 3. 动作状态机引擎 (ActionManager)

### 3.1 核心机制
每个角色持有一个 `ActionManager`，负责维护角色的“忙碌”状态。
*   **`ActionInstance`**: 代表一个具体的动作执行过程，记录已流逝帧数和待触发的判定帧（`hit_frames`）。
*   **取消窗口 (Cancel Window)**: 允许在特定帧后通过切换动作来中断当前动作的后摇。
*   **回调机制**: 动作执行完成后，通过 `runtime_skill_obj` 触发后续逻辑。

## 4. 元素附着理论 (Aura Theory V2)

### 4.1 ICD 管理
V2 实现了基于标签的全局 ICD 控制。
*   **标签隔离**: “普通攻击”、“元素战技”等不同攻击源拥有独立的计数器序列。
*   **重置规则**: 遵循 2.5s / 3 次打击重置的通用规则，支持特定技能的独立附着设置。

### 4.2 反应映射
`ReactionSystem` 建立了一套完整的反应优先级矩阵，确保在多元素环境下（如雷草水）反应触发的确定性。

---
*版本: v2.5.0*
*更新日期: 2026-02-07*
