# Genshin Damage Calculation - 测试指南 (V2)

本项目采用基于 **Pytest** 的分层测试架构。V2 架构引入了场景中心化与物理实体化，测试体系也随之升级以确保高精度几何判定与复杂反应链条的稳定性。

## 1. 测试架构概览

测试目录结构如下：

```text
tests/
├── conftest.py             # 全局配置与 V2 标准 Mock 实体 (CombatEntity 兼容)
├── unit/                   # 单元测试：验证各原子系统的计算逻辑
│   ├── systems/            # 核心系统 (Damage, Reaction, Energy 等)
│   └── mechanics/          # 核心机制 (附着论, ICD, 附魔优先级)
└── integration/            # 集成测试：端到端验证 (如：香菱 Q 技能全流程判定)
```

## 2. 核心组件 (Mocking V2)

编写测试时，建议优先使用 `MockAttributeEntity`（定义于 `conftest.py`）。它对齐了 V2 实体标准：

*   **属性面板 (`attribute_panel`)**：所有数值（攻击、精通、抗性）均统一存储在此字典中。
*   **状态管理**：内置 `AuraManager` (元素附着) 和 `ICDManager` (附着冷却)。
*   **物理接口**：实现了 `handle_damage` 协议，能自动处理附着、反应回填及 ICD 状态更新。

## 3. 编写测试规范

### 3.1 属性计算测试 (单元测试)
验证乘区公式时，通过修改 `attribute_panel` 并驱动 `DamagePipeline`：

```python
def test_res_mult(pipeline, ctx, target_entity):
    # V2 规范：从 attribute_panel 修改抗性
    target_entity.attribute_panel['火元素抗性'] = -20.0 
    pipeline._calculate_def_res(ctx)
    # 结果应为 1 - (-20/200) = 1.1
    assert ctx.stats["抗性区系数"] == pytest.approx(1.1)
```

### 3.2 动作与空间判定测试 (集成测试)
V2 引入了 `CombatSpace`，需要验证攻击的几何范围与分段判定：

```python
def test_circular_aoe(space, source_entity, target_entity):
    # 设置攻击范围：半径 5.0 的圆形
    # 目标在 (3, 0)，应当被命中
    target_entity.set_position(3.0, 0.0)
    hits = space.broadcast_damage(source_entity, radius=5.0)
    assert target_entity in hits
```

## 4. 核心断言参考

| 验证项 | 推荐方法 / 位置 | 注意事项 |
| :--- | :--- | :--- |
| **基础伤害** | `ctx.final_result` | 需考虑所有乘区叠加 |
| **元素反应** | `dmg.reaction_results` | 检查反应类型及残留元素量 |
| **能量获取** | `ctx.logger.logs` | 检查 `EnergySystem` 发布的回能事件 |
| **ICD 冷却** | `target.icd_manager` | 验证多段攻击中哪几段触发了附着 |

## 5. 运行测试命令

在 PowerShell 环境下执行：

```powershell
# 运行全量测试 (推荐提交前执行)
.\genshin_damage_calculation\Scripts\python.exe -m pytest

# 运行特定模块并开启详细日志
.\genshin_damage_calculation\Scripts\python.exe -m pytest tests/unit/mechanics/test_aura_theory.py -v -s
```

## 6. 开发规范
*   **物理实体隔离**：严禁在测试中手动修改实体的私有状态，应通过 `set_position` 或 `handle_damage` 等公共接口驱动。
*   **测试清理**：每个测试用例运行前都会通过 `conftest.py` 重置 `SimulationContext`，无需担心状态污染。
