# 原神伤害计算器 - 架构概览 (V2)

## 1. 设计哲学
本项目采用 **“场景中心化 (Scene-Centric)”** 与 **“事件驱动 (Event-Driven)”** 的设计理念，将战斗模拟从简单的数值计算升级为具备物理空间感、动作时间轴和复杂状态机交互的仿真引擎。

## 2. 系统分层架构

### 2.1 基础设施层 (Infrastructure)
*   **`SimulationContext`**: 系统的“真理来源”。持有当前帧数、战斗空间 (`CombatSpace`)、事件引擎 (`EventEngine`) 和所有实体的引用。通过 `ContextVar` 实现逻辑隔离。
*   **`EventEngine`**: 神经中枢。支持事件监听、冒泡拦截和跨系统通信。
*   **`Registry`**: 自动发现与加载机制。负责扫描并注册角色、武器、圣遗物和各种效果。

### 2.2 物理与场景层 (Scene & Physics)
*   **`CombatSpace`**: 核心空间管理器。负责维护实体位置、朝向，并执行高精度几何碰撞检测（球体、圆柱、长方体、扇形）。
*   **`CombatEntity`**: 基础战斗实体。所有角色、怪物、部署物（如锅巴、旋火轮、草原核）均继承自此类，具备位置、生命周期、元素附着（Aura）和 ICD 管理能力。

### 2.3 动作与控制层 (Action & ASM)
*   **`ActionManager (ASM)`**: 动作状态机引擎。控制实体的动作时间轴，处理判定点、动作取消窗口（Cancel Window）以及技能间的流转。
*   **`Skill System`**: 模块化技能实现。支持参数化触发（如：点按、长按、分段触发）。

### 2.4 业务子系统层 (Systems)
*   **`DamageSystem`**: 伤害流水线 (`DamagePipeline`) 驱动者。处理快照、倍率计算及乘区合并。
*   **`ReactionSystem`**: 元素反应中枢。监听附着事件，根据附着论执行消耗、叠层与反应触发。
*   **`Energy/Shield/Health Systems`**: 处理能量循环、护盾逻辑与生命值变动。

## 3. 业务表现层 (GUI - NiceGUI)

项目采用 **"MD3 Panes"** 面板化架构，并实施了 **“状态-视图分离 (State-View Separation)”** 模式以管理复杂的交互状态。

### 3.1 渲染模式
*   **多阶段状态机**: 页面通过 `state.phase` (Strategic/Tactical/Review) 进行顶层路由分发。
*   **局部刷新**: 结合 `@ui.refreshable` 与回调函数，实现细粒度的 UI 更新，避免全局重绘导致的闪烁。

### 3.2 文件组织规范 (V2.2+)
*   **`xxx_state.py`**: 持久化状态管理。包含数据导出、文件 I/O 与业务逻辑计算。
*   **`xxx_parts.py`**: 可复用大型组件库。封装复杂的渲染逻辑（如属性编辑器、动作磁贴）。
*   **`xxx.py`**: 页面路由入口。定义外壳布局并执行组件分发。

## 4. 核心执行流
1.  **环境装配**: `create_context()` 初始化上下文并挂载所有子系统。
2.  **实体加载**: `TeamFactory` 解析配置，生成角色与目标并注册到 `CombatSpace`。
3.  **主循环 (Tick)**: 
    *   `advance_frame()` 推进时间轴。
    *   驱动 `ActionManager` 更新当前动作进度。
    *   发布 `BEFORE_DAMAGE` 等事件。
    *   `CombatSpace` 广播伤害并触发目标受击响应。
    *   `DamagePipeline` 完成数值结算。
    *   更新实体状态。

## 4. 扩展规范
*   **模块化角色**: 每个角色拥有独立的目录，将逻辑拆分为属性、技能、实体与效果，确保代码高度可维护性。
*   **契约化攻击**: 通过 `AttackConfig` 和 `HitboxConfig` 定义攻击，实现数值与物理表现的解耦。

---
*版本: v2.1.0*
*日期: 2026-02-08*
