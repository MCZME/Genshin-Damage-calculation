# V2 架构重构与仿真踩坑记录

本文档记录了在从 V1 迁移至 V2“场景中心化”架构过程中遇到的核心技术问题（坑）及其对策，旨在为后续角色开发与系统维护提供参考。

## 1. 环境初始化与加载顺序

### 1.1 数据库初始化与配置冲突
*   **现象**: 报错 `'NoneType' object has no attribute 'get'`，提示数据库连接池初始化失败。
*   **原因**: `core.data.database` 在模块顶层通过 `Config.get()` 获取配置。由于 Python 的导入副作用，如果在 `Config()` 单例实例化之前导入了 `MySQLDataRepository`（或任何依赖它的 UI 页面），会导致配置项尚未加载。
*   **对策**: 在 `main.py` 入口的最顶层（第一行业务导入之前）强制初始化 `Config`：
    ```python
    from core.config import Config
    Config() # 必须最先执行，早于任何 NiceGUI 页面导入
    from core.logger import logger_init
    logger_init()
    
    # 之后再导入其他模块
    from nicegui import ui
    from ui.pages import config as _config_page
    ```

### 1.2 动态扫描 (Registry) 失败
*   **现象**: 启动时大量 `Skipping module...` 警告。
*   **原因**: 许多旧版角色文件仍在尝试导入已废弃的 `core.base_class` 或 `CharacterState`。
*   **影响**: 虽然不影响核心已适配角色的运行，但会污染日志并导致旧角色无法在 V2 下使用。

## 2. 数据契约 (Data Contracts)

### 2.1 实体属性 Key 名不对齐
*   **现象**: 模拟能跑通，但伤害始终为 0。
*   **原因**: `Character` 基类的 `__init__` 预期的是数据库风格的 Key（如 `base_hp`, `base_atk`, `base_def`），而 Mock 数据或旧代码常使用中文 Key（如 `攻击力`）。
*   **对策**: 统一使用 `base_xxx` 作为基础属性注入名。最终计算应始终通过 `AttributeCalculator` 提取。

### 2.2 字段重命名与兼容性 (Scaling Stat)
*   **现象**: 核心动作类（Damage, Shield）中的 `base_value` 命名歧义，易与“基础伤害区”混淆。
*   **对策**: 将其重命名为 **`scaling_stat`**（属性收益类型）。为了保持对未迁移角色代码的兼容，在 `Damage` 类中通过 `@property` 实现了 `base_value` 的别名映射。

## 3. 核心驱动逻辑

### 3.1 ASM (动作状态机) 与 Simulator 的脱节
*   **现象**: `AttributeError: 'ActionManager' object has no attribute 'request_action_by_name'`。
*   **原因**: `Simulator` 设计了通过方法名请求动作的接口，但 `ActionManager` 尚未正式实现该协议。
*   **对策**: 在 `ActionManager` 中实现了 `request_action_by_name`，利用 `getattr(character, method_name)` 桥接 Simulator 指令与角色技能方法。

### 3.2 模拟提前终止
*   **现象**: 设置了 120 帧的跳过动作，但模拟在第 40 帧左右就退出了。
*   **原因**: `Simulator` 的 `_is_finished` 判定逻辑较为严格。当后续动作（如 `skip`）被成功压入且当前角色 `action_manager` 状态不稳时，可能误判为所有任务已完成。
*   **现状**: 目前通过精简动作序列来规避，后续需要进一步调优取消窗口（Cancel Window）逻辑。

## 4. 战斗全链路闭环

### 4.1 事件发布缺失 (致命坑)
*   **现象**: 三段挥舞伤害虽然触发了，但没有任何数值产出且不触发 `AFTER_DAMAGE` 监听。
*   **原因**: 技能逻辑（如 `on_execute_hit`）直接调用了 `ctx.space.broadcast_damage`。在 V2 架构下，这会**绕过事件流水线**，导致 `DamageSystem` 无法感知到伤害请求。
*   **对策**: 严禁在技能中直接调用广播。必须发布 `BEFORE_DAMAGE` 事件，由 `DamageSystem` 统一接管后续的快照、广播和结算：
    ```python
    # 正确做法
    self.caster.event_engine.publish(GameEvent(EventType.BEFORE_DAMAGE, ...))
    ```

## 5. UI 与持久化架构

### 5.1 异步测试陷阱
*   **现象**: `RuntimeError: There is no current event loop in thread 'MainThread'`。
*   **原因**: `aiosqlite` 强依赖 `asyncio` 循环，而 `pytest-trio` 默认使用 `trio` 循环。两者不兼容。
*   **对策**: 引入 `pytest-asyncio` 插件，并使用 `@pytest.mark.asyncio` 标记相关测试，确保测试环境与生产环境（NiceGUI 基于 asyncio）一致。

### 5.2 本地模块命名冲突
*   **现象**: `module 'ui' has no attribute 'run'`。
*   **原因**: 项目根目录下存在 `ui/` 文件夹，`import ui.pages...` 导致本地包覆盖了 `nicegui.ui` 模块。
*   **对策**: 在导入时使用别名 `from ui.pages import config as _config_page`，避免污染全局命名空间。

---
*最后更新: 2026-02-07*