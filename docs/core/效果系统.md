# Core - 效果系统 (Effect System)

效果系统负责处理仿真中的所有增益 (Buff)、减益 (Debuff)、持续伤害 (DoT) 以及复杂的特殊状态逻辑。在 V2.3 架构中，效果系统进行了深度精简，以支持更纯粹的事件驱动计算。

## 1. 核心模块结构
为了保持架构的灵活性，目前仅保留核心定义，具体的业务逻辑（如圣遗物套装、角色天赋）应在对应的子包中实现：
- `core/effect/base.py`: 定义效果的基类 `Effect` 及其生命周期。
- `core/effect/common.py`: 存放标准化的通用效果（如 `TalentEffect`, `ConstellationEffect`）。

## 2. 效果生命周期 (Hooks)
`Effect` 实例通过以下钩子函数接入仿真的每一帧：
- **`apply()`**: 激活效果。
- **`remove()`**: 销毁效果，清理关联属性。
- **`on_frame_update()`**: 每帧驱动逻辑（由挂载实体的 `on_frame_update` 调用），用于倒计时、叠层或持续触发逻辑。

## 3. 两种加成实现路径

### 3.1 静态属性修改 (Static Stats)
适用于持久生效的加成（如：天赋常驻增加 20% 生命值）。
- **实现**: 在 `apply()` 阶段直接修改角色的 `attribute_panel`。
- **注意**: 必须在 `remove()` 时还原修改，以防脏数据。

### 3.2 动态计算修正 (Dynamic Calculation)
适用于基于特定条件的瞬时加成（如：重击时暴击率提高 15%）。
- **实现**: 效果类需实现 `EventHandler` 接口，订阅 `EventType.BEFORE_CALCULATE` 事件。
- **流程**:
    1. 伤害系统准备计算前发布 `BEFORE_CALCULATE`。
    2. 效果类在 `handle_event` 中检查当前 `damage_context` 的属性（如攻击类型）。
    3. 若符合条件，直接修改 `event.data["damage_context"].stats` 中的中间变量。

```python
def handle_event(self, event: GameEvent):
    if event.event_type == EventType.BEFORE_CALCULATE:
        ctx = event.data["damage_context"]
        # 判定是否为重击
        if ctx.damage.damage_type == DamageType.CHARGED:
            ctx.stats["暴击率"] += 15.0
```

## 4. [Important] 架构调整说明
**V2.3 已移除 `core/effect/stat_modifier.py` 等旧版模板文件。** 

**核心变更：**
- **去属性硬编码**: 效果不再依赖于特定的字典键值对，而是通过事件上下文进行交互。
- **生命周期所有权**: 效果的生存周期由其挂载的 `Character` 实例全权负责（通过 `self.talents` 或 `self.active_effects` 列表）。

## 5. 通用效果类 (Standard Classes)

为了减少重复代码，系统在 `core/effect/common.py` 中提供了一系列开箱即用的标准效果：

### 5.1 StatModifierEffect
用于直接修改实体的属性面板。
- **优点**: 自动处理 `on_apply` 时的加法和 `on_remove` 时的减法，避免属性泄露。
- **场景**: 天赋常驻加成、技能触发的临时攻击力提升。

### 5.2 ResistanceDebuffEffect
专门用于削减目标抗性。
- **参数**: 接收元素列表（如 `["火", "冰"]`）和削减比例。
- **场景**: 超导（-40% 物理）、万叶翠绿套（-40% 对应元素）。

---
*版本: V2.3.1 (Event-Driven Modifiers)*
*更新日期: 2026-02-12*
