# Core - 效果系统 (Effect System)

效果系统（Buff/Debuff）负责处理所有属性加成、持续伤害（DoT）和特殊状态逻辑。

## 1. 物理隔离设计
为了应对复杂的技能效果并保持代码整洁，效果逻辑按来源进行文件隔离：
- `core/effect/base.py`: 定义生命周期基类。
- `core/effect/stat_modifier.py`: 通用属性加成模板。
- `core/effect/elemental.py`: 元素附魔与附着相关效果。
- `core/effect/resonance.py`: 元素共鸣效果。

## 2. 核心基类 (`BaseEffect`)
通过完整的生命周期钩子实现复杂的逻辑：
- **`on_apply()`**: 获得效果瞬间触发（如：快照、属性持久修改）。
- **`on_tick()`**: 每一帧触发（由 `CombatEntity.update()` 驱动，用于剧变反应或 DoT）。
- **`on_remove()`**: 效果消失瞬间触发（如：属性还原）。
- **`on_stack_added()`**: 当重复获得相同效果时的堆叠/刷新处理。

## 3. 堆叠规则 (`StackingRule`)
控制同名效果的共存方式：
- **`REFRESH`**: (默认) 刷新持续时间至新值（取最大值）。
- **`ADD`**: 增加层数（调用 `on_stack_added`）。
- **`INDEPENDENT`**: 独立存在，互不干扰。

## 4. 属性修改规范
推荐使用 `StatModifierEffect` 处理简单的数值加成，它会自动处理添加与移除时的属性回退：

```python
# 示例：创建并应用一个 20% 攻击力加成，持续 10 秒
from core.effect.stat_modifier import StatModifierEffect

buff = StatModifierEffect(owner, "我的增益", {"攻击力%": 20.0}, duration=600)
buff.apply()
```

## 5. 与 V2 架构的整合
- **去全局化**: 所有的 Effect 内部通过 `self.owner.ctx` 访问环境，确保状态隔离。
- **自动清理**: 当 `CombatEntity` 被销毁时，所有挂载的 `active_effects` 会自动停止 `update`。

---
*版本: V2.0*
*更新日期: 2026-02-07*
