# Core - 反应系统 (Reaction System)

反应系统负责仿真《原神》核心的元素交互逻辑。它基于**附着论 (Elemental Gauge Theory)**，通过事件驱动机制精确模拟元素量消耗、反应优先级、ICD 以及复杂的连锁反应逻辑。

## 1. 核心分层架构

反应逻辑被拆分为三个核心层级，以实现物理判定与逻辑结算的解耦：

### 1.1 状态持有层 (`core.mechanics.aura`)
*   **Aura (元素附着)**: 附着在实体上的元素状态。
*   **Gauge (元素量)**: 严格遵循 1U/2U/4U 标准。
*   **周期性 Tick**: 负责驱动感电（每秒扣减/跳电）与燃烧（每 0.25s 挂火/爆发伤害）的计时逻辑。

### 1.2 物理交互层 (`core.combat_space`)
*   **物理化副作用**: 某些反应会产生具体的战场实体。
    *   **结晶 (Crystallize)**: 产生 `CrystalShardEntity` (晶片)，角色靠近后自动拾取获得护盾。
    *   **绽放 (Bloom)**: 产生 `DendroCoreEntity` (草原核)，存在 6s 或上限 5 个后自动爆炸。
*   **空间广播**: 扩散 (Swirl) 会在命中点触发 6m 范围的物理广播，将元素传播至周围目标。

### 1.3 逻辑结算层 (`ReactionSystem`)
*   **剧变伤害产生**: 监听 `BEFORE_DAMAGE` 或反应 Tick 事件，生成独立的剧变伤害对象。
*   **受击 ICD 机制**: 严格限制同一目标对同类剧变伤害的接受频率——**0.5s (30帧) 内最多受 2 次伤害**。

---

## 2. 反应效果详述

| 反应类型 | 类别 | 物理表现 / 副作用 |
| :--- | :--- | :--- |
| **蒸发/融化** | 增幅 | 无实体，直接提升本次伤害倍率。 |
| **感电** | 剧变 | 水雷共存，每秒触发一次跳电伤害。 |
| **超载** | 剧变 | 产生火元素范围伤害。 |
| **超导** | 剧变 | 产生冰元素范围伤害，降低目标 **40% 物理抗性**，持续 12s。 |
| **扩散** | 剧变 | 造成对应元素伤害，并将该元素传播至 6m 内的其他实体。 |
| **结晶** | 状态 | 掉落对应元素晶片，拾取后获得 15s 属性匹配护盾。 |
| **绽放** | 剧变 | 生成草原核。受火/雷攻击触发烈/超绽放。 |
| **激化** | 状态 | 产生激元素。后续雷/草攻击享受固定伤害值加成。 |

---

## 3. 元素附着规则 (Gauge Theory)

### 3.1 刷新规则 (Refresh)
当实体已带有同元素附着时：
- **元素量**: 取当前剩余量与新附着量中的**较大值**。
- **衰减速率**: 强制覆盖为**新附着量的衰减速率**（关键：1U 无法覆盖 2U 的量，但会加快其消失）。

### 3.2 反应消耗 (Tax)
- **增幅反应**: 存在 2.0x (强克制) 和 0.5x (弱克制) 的消耗比。
- **风/岩反应**: 固定的 0.5x 消耗比，且作为后置元素时永不残留。

---

## 4. 开发指南

1.  **受击限制**: 所有剧变伤害均通过 `_generate_transformative_damage` 产生，自动享受受击 ICD 保护。
2.  **自定义反应**: 若需增加纳塔等特殊反应，在 `core/action/reaction.py` 定义枚举并在 `ReactionSystem` 注册分支。

---
*版本: V2.3.2 (Physical Side-effects)*
*更新日期: 2026-02-12*
