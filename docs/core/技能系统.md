# Core - 技能系统 (Skill System)

技能系统是连接 `Character` 实体与 `ActionManager` (ASM) 引擎的翻译层，负责将玩家意图转换为物理动作指令。

---

## 1. 核心设计：无状态动作工厂 (Stateless Factory)

在 V2.4 架构中，技能对象不再持有任何业务状态（如连击索引、计时器），它们唯一的职责是 **“根据意图映射配置”**。

### 1.1 核心接口契约
- **`to_action_data(intent)`**: 
    - **逻辑**: 根据意图字典从角色 `data.py` 中提取对应的帧数与物理配置。
    - **自动连招**: 对于普攻，该方法只需返回对应段位的元数据，ASM 会自动处理段位推进。
- **`on_execute_hit(hit_index)`**: 
    - **职责**: 到达判定帧时，发布 `BEFORE_DAMAGE` 事件。
    - **规范**: 必须使用“空间广播”模式，严禁在此时手动搜索单一目标。

---

## 2. 标准化技能组件

项目提供了一系列通用组件，角色只需通过注入 `data.py` 的字典即可完成实装。

### 2.1 普通攻击 (`NormalAttackSkill`)
- **自动映射**: 自动关联 `ACTION_FRAME_DATA["NORMAL_X"]` 和 `ATTACK_DATA["NORMAL_X"]`。
- **多段支持**: 通过 `hit_index` 自动索引 `NORMAL_ATTACK_DATA` 中的倍率。

### 2.2 移动技能 (`DashSkill`, `JumpSkill`)
- **物理化**: 产出带有类型标签的动作，由 ASM 驱动。位移逻辑在 `on_frame_update` 回调中实现。

---

## 3. 实现规范 (示例)

```python
class MyElementalSkill(SkillBase):
    def to_action_data(self, intent=None) -> ActionFrameData:
        # 1. 从局部配置中心获取数据
        frames = ACTION_FRAME_DATA["SKILL_PRESS"]
        physics = ATTACK_DATA["SKILL_PRESS"]
        
        # 2. 构造并返回
        return ActionFrameData(
            name="SKILL_PRESS",
            action_type="elemental_skill",
            total_frames=frames["total_frames"],
            hit_frames=frames["hit_frames"],
            interrupt_frames=frames["interrupt_frames"],
            attack_config=AttackConfig(
                element_u=physics["element_u"],
                hitbox=HitboxConfig(shape=AOEShape.SPHERE, radius=physics["radius"])
            ),
            origin_skill=self
        )

    def on_execute_hit(self, hit_index: int):
        # 触发伤害广播
        self.caster.event_engine.publish(GameEvent(EventType.BEFORE_DAMAGE, ...))
```

---

## 4. 元数据发现 (Metadata Discovery)
UI 通过类方法 `get_action_metadata()` 获取参数 Schema（如滑块、下拉框），生成的 `intent` 字典将作为参数传回 `to_action_data`。

---
*版本: V2.4 (Stateless Factory)*
*更新日期: 2026-02-12*
