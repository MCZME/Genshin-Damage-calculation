# Core - 技能系统 (Skill System)

技能系统是连接 `Character` 实体与 `ActionManager` (ASM) 引擎的翻译层，负责将玩家意图转换为物理动作指令。

---

## 1. 核心设计：无状态动作工厂 (Stateless Factory)

在 V2.4 架构中，技能对象不再持有任何业务状态（如连击索引、计时器），它们唯一的职责是 **“根据意图映射配置”**。

### 1.1 统一标识符 (Action Keys)
UI 传入的动作 ID 必须与 `Character.skills` 字典的 Key 严格一致。标准 Key 如下：
- `normal_attack`: 普通攻击。
- `elemental_skill`: 元素战技。
- `elemental_burst`: 元素爆发。
- `charged_attack`: 重击。
- `plunging_attack`: 下落攻击。
- `dash`, `jump`, `skip`: 移动与等待。

### 1.2 核心接口契约
- **`to_action_data(intent)`**: 
    - **逻辑**: 根据意图字典从角色 `data.py` 中提取对应的帧数与物理配置。
    - **高度判定**: 下落攻击等技能在此处根据当前高度决定“高空/低空”模式，并将快照存入 ActionData。
- **`on_execute_hit(hit_index)`**: 
    - **职责**: 到达判定帧时，发布 `BEFORE_DAMAGE` 事件。
    - **规范**: 必须使用“空间广播”模式，通过 `ctx.space.broadcast_damage` 分发。

---

## 2. 标准化技能组件

### 2.1 普通攻击 (`NormalAttackSkill`)
- **自动段位**: 调用时若未指定索引，会自动从 ASM 获取当前 `combo_counter`。

### 2.2 物理联动逻辑 (`on_frame_update`)
技能对象通过 `on_frame_update` 处理跨帧的业务逻辑：
- **下落攻击**: 每帧修改角色高度（Y轴），检测落地时刻触发冲击伤害并终止动作。
- **状态监测**: 在后台持续更新计时器、触发元素附着或生成微粒。

---

## 3. 实现规范 (示例)

```python
class MyElementalSkill(SkillBase):
    def to_action_data(self, intent=None) -> ActionFrameData:
        # 1. 直接通过 backend key 索引配置
        frames = ACTION_FRAME_DATA["elemental_skill"]
        
        # 2. 构造物理快照
        return ActionFrameData(
            name="元素战技",
            action_type="elemental_skill",
            # ... 配置时序与位移
            origin_skill=self
        )

    def on_execute_hit(self, hit_index: int):
        # 触发伤害广播
        dmg_obj = Damage(...)
        self.caster.event_engine.publish(GameEvent(EventType.BEFORE_DAMAGE, ...))
```

---
*版本: V2.4.1 (Scene-Centric & Stateless Factory)*
*更新日期: 2026-02-14*
