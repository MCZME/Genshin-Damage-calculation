# Core - 护盾系统 (Shield System)

护盾系统负责仿真角色的生存屏障逻辑。它模拟了《原神》中护盾的叠加、元素吸收率以及护盾强效的综合作用。

## 1. 核心模型

### 1.1 ShieldEffect
护盾并不被视为独立的物理实体，而是一种特殊的 `BaseEffect` 挂载在角色（`CombatEntity`）身上。
- **HP (current_hp/max_hp)**: 护盾的剩余量与最大容量。
- **元素 (Element)**: 护盾的元素属性，决定了对不同伤害类型的吸收效率。

### 1.2 护盾列表 (`CombatEntity.shield_effects`)
每个战斗实体持有一个活跃护盾列表。当受到攻击时，系统会遍历此列表进行吸收结算。

---

## 2. 护盾吸收逻辑

本系统严格遵循《原神》底层的护盾机制：

### 2.1 多盾同时扣除
**关键规则**: 受到伤害时，所有处于活跃状态的护盾会**同时**承受该次伤害。
- 护盾并不是按顺序一个接一个消耗，而是平行的。
- 这意味着同时套多个盾并不能增加总血量，但能增加不同元素下的生存能力。

### 2.2 元素吸收效率 (Absorption)
系统根据护盾元素与伤害元素的匹配情况，动态调整吸收率：
- **匹配元素**: 若伤害元素与护盾元素相同（如冰盾抗冰），吸收效率为 **250%**。
- **岩元素护盾**: 对所有类型的伤害（含物理）均有 **150%** 的吸收效率。
- **不匹配情况**: 吸收效率为 **100%**。

**计算公式**:
```text
护盾消耗量 = 原始伤害 / 吸收效率
```

### 2.3 护盾强效 (Shield Strength)
在护盾生成瞬间，系统会抓取创建者的“护盾强效”属性：
```text
最终护盾量 = 基础护盾量 * (1 + 创建者护盾强效 / 100)
```

### 2.4 无视护盾伤害 (Ignore Shield)
**例外规则**: 某些特定类型的伤害（如侵蚀、流血效果）可以绕过护盾直接作用于实体生命值。
- **判定方式**: 检查 `BEFORE_HURT` 事件的 `data` 字典中是否存在 `ignore_shield: True`。
- **表现**: 若标记存在，`ShieldSystem` 将完全跳过该次伤害的吸收判定，保持 `amount` 数值不变。

---

## 3. 系统分发流程

1.  **触发**: 角色即将受到伤害，`HealthSystem` 发布 `BEFORE_HURT` 事件。
2.  **拦截**: `ShieldSystem` 监听到事件，开始遍历角色的 `shield_effects`。
3.  **抵扣**:
    - 计算每个护盾能吸收的最大原始伤害。
    - 找出所有护盾中能吸收的**最大原始伤害量** (`max_absorbed`)。
    - 同步扣除所有活跃护盾的 HP。
4.  **修正**: `ShieldSystem` 修改 `GameEvent` 中的 `amount` 数值。
    - `剩余伤害 = max(0, 原始伤害 - max_absorbed)`。
5.  **透传**: 修正后的事件继续传递给 `HealthSystem` 执行实际扣血。

---

## 4. 开发建议

- **产生护盾**: 调用 `ShieldSystem.add_shield(target, config)` 接口。
- **结晶盾**: 建议由 `ReactionSystem` 触发时调用该接口生成对应元素的护盾。

---
*版本: V2.3.1*
*更新日期: 2026-02-12*
