# Core - 动作状态机 (ASM Engine)

`ActionManager` 负责实体动作的物理时序、连招管理以及精细化取消逻辑。

---

## 1. 核心数据结构

### 1.1 ActionInstance (动作实例)
代表当前正在物理运行的动作。
- **物理状态**: `elapsed_frames`（已流逝帧数）。
- **生命周期**: 
    - **自动结束**: `elapsed_frames` 达到 `total_frames`。
    - **逻辑终止**: 技能对象通过 `action_manager._terminate_current()` 手动结束（如下落攻击触地）。
    - **取消**: 被更高优先级的动作中断。

---

## 2. 级联驱动模型 (V2.4)

ASM 的推进不再由模拟器直接控制，而是遵循以下驱动链：
1. **脉冲**: `Simulator` 触发全局帧。
2. **分发**: `CombatSpace` 调用 `Team.on_frame_update()`。
3. **触达**: `Character` 调用 `action_manager.on_frame_update()`。

---

## 3. 驱动逻辑

### 3.1 动作请求流程 (`request_action`)
1.  **自动连招同步**：如果是 `normal_attack`，ASM 自动分配 `combo_index` 并推进 `combo_counter`。
2.  **标识符统一**：请求名必须匹配 `elemental_skill` 等后端标准 Key。
3.  **中断检查**：
    - 对比 `current_action.interrupt_frames[next_action.action_type]` 与已流逝帧数。
    - 若满足取消窗口，则强制注销当前动作并启动新动作。

### 3.2 帧驱动 (`on_frame_update`)
- **位移处理**：将 `horizontal_dist` 平摊到总帧数执行 X/Z 位移。
- **命中触发**：到达 `hit_frames` 时调用 `origin_skill.on_execute_hit()`。
- **外部联动**: 下落攻击等物理相关动作在 `Skill.on_frame_update` 中控制 Y 轴，并通过 ASM 接口控制动作生命周期。

---
*版本: V2.4.1 (Scene-Centric & Cascade Driver)*
*更新日期: 2026-02-14*
