# Core - 动作状态机 (ASM Engine)

`ActionManager` 是仿真的心脏，负责处理实体的所有动作（普攻、技能、冲刺等）的时间轴管理。

## 1. 核心概念
ASM 引擎将动作抽象为 **物理帧序列 (Frames)**，实现高精度的动作表现与取消逻辑。

### 1.1 ActionFrameData (动作元数据)
定义了一个动作固有的物理与时间参数。这些参数由技能系统在实例化动作时提供，UI 无法直接干预。
- **`name`**: 动作内部标识。
- **`total_frames`**: 动画总时长。
- **`hit_frames`**: 伤害判定帧序列。
- **`horizontal_dist`**: 该动作自带的水平位移量。由 ASM 在执行过程中平摊到每一帧。
- **`cancel_windows`**: 允许被其他动作取消的起始帧字典（如 `{"dash": 12}`）。
- **`origin_skill`**: 绑定的逻辑回调对象。

### 1.2 ActionInstance (动作实例)
代表当前正在执行的动作，持有已流逝帧数和待处理的判定点。

## 2. 驱动逻辑

### 2.1 请求动作 (`request_action`)
外部通过 `ActionFrameData` 请求执行新动作。`ActionManager` 会检查：
1. **取消窗口**: 如果当前动作已进入 `cancel_window` 定义的阈值，则中断当前动作。
2. **状态切换**: 如果无法取消，则拒绝新动作请求。

### 2.2 每一帧更新 (`on_frame_update`)
由 `Simulator` 或 `Character` 在每帧调用：
1. **帧计数**: `elapsed_frames` 递增。
2. **位移处理**: 自动更新上下文中的全局位移计数（基于 `horizontal_dist`）。
3. **技能回调**: 若绑定了 `origin_skill`，则调用其 `on_frame_update()`。
4. **命中判定**: 到达判定点时触发 `_trigger_hit()`，通过 `origin_skill` 的 `on_execute_hit()` 回调业务逻辑。

---
*版本: V2.2 (Displacement Intrinsic)*
*更新日期: 2026-02-09*
