# Core - 动作状态机 (ASM Engine)

`ActionManager` 是仿真的心脏，负责处理实体的所有动作（普攻、技能、冲刺等）的时间轴管理。

## 1. 核心概念
ASM 引擎将动作抽象为 **帧序列 (Frames)**，实现高精度的动作表现与取消逻辑。

### 1.1 ActionFrameData (动作元数据)
定义了一个动作的物理参数：
- **`name`**: 动作内部名称（如 "Q_CAST"）。
- **`total_frames`**: 动作总长度。
- **`hit_frames`**: 所有的伤害判定点（如第 18, 33, 56 帧）。
- **`cancel_windows`**: 允许被其他动作取消的起始帧字典。
- **`origin_skill`**: [NEW] 运行时绑定的原始技能对象，用于触发回调。

### 1.2 ActionInstance (动作实例)
代表当前正在执行的动作，持有已流逝帧数和待处理的判定点。

## 2. 驱动逻辑

### 2.1 请求动作 (`request_action`)
外部通过请求执行新动作。`ActionManager` 会检查：
1. **取消窗口**: 如果当前动作已进入 `cancel_window` 定义的阈值，则中断当前动作。
2. **状态切换**: 如果无法取消，则拒绝新动作请求。

### 2.2 每一帧更新 (`on_frame_update`)
由 `Simulator` 或 `Character` 在每帧调用：
1. **帧计数**: `elapsed_frames` 递增。
2. **技能回调**: 若绑定了 `origin_skill`，则调用其 `on_frame_update()`。
3. **命中判定**: 若到达 `hit_frames` 之一，自动触发 `_trigger_hit()` 回调技能对象的 `on_execute_hit()`。
4. **位移处理**: 自动更新上下文中的全局位移计数。

## 3. 动作取消 (Cancel Logic)
通过 `cancel_windows` 实现类似《原神》游戏中的“闪避取消”、“跳跃取消”：
```python
# 示例：12 帧后可以闪避，15 帧后可以跳跃
data.cancel_windows = {"dash": 12, "jump": 15, "ANY": 40}
```

---
*版本: V2.1*
*更新日期: 2026-02-07*
