# Core - 伤害系统 (Damage System)

伤害系统是仿真引擎的中枢，负责从攻击意图到最终数值结算的全流程逻辑。它采用了**流水线 (Pipeline)** 设计，确保了计算过程的标准化与高度可扩展性。

## 1. 核心概念

### 1.1 Damage 对象 (`core.action.damage.Damage`)
伤害的载体，包含了攻击的本质属性：
- **倍率 (`damage_multiplier`)**: 基础伤害百分比。
- **元素 (`element`)**: 攻击的元素类型与元素量 (Gauge)。
- **攻击契约 (`config`)**: 即 `AttackConfig`，定义了 ICD 标签、打击类型和 Hitbox。
- **实时属性 (`panel`)**: 存储该次伤害生效时的修正数据。

### 1.2 DamageContext
计算过程中的上下文快照，持有计算所需的中间变量（如各乘区系数），确保计算逻辑不直接修改原始实体属性。

---

## 2. 伤害流水线 (DamagePipeline)

每当触发 `BEFORE_DAMAGE` 事件时，`DamageSystem` 会启动 `DamagePipeline` 执行以下七个阶段：

### 第一阶段：属性快照 (`_snapshot`)
系统通过 `AttributeCalculator` 抓取攻击者当前的实时面板（攻击力、精通、双暴、伤害加成等），并将其存入 `DamageContext`。

### 第二阶段：计算前修正 (事件驱动)
发布 `BEFORE_CALCULATE` 事件。
- **用途**: 允许各种效果 (Effect) 监听此事件，并根据当前攻击类型动态修改 `DamageContext.stats`（例如：增加 15% 重击暴击率）。

### 第三阶段：物理广播与碰撞 (`_dispatch_broadcast`)
对接 `CombatSpace`。
- **单体**: 直接作用于锁定目标。
- **AOE**: 根据 Hitbox 形状（圆柱、长方体等）在场景中检索受击者。
- **结果**: 建立 `damage.target` 引用，并触发目标的 `handle_damage` 接口（执行 ICD 判定）。

### 第四阶段：反应预处理 (`_preprocess_reaction_stats`)
根据第三阶段反馈的反应结果（如增幅反应、激化），注入对应的倍率加成或固定伤害加成。

### 第五阶段：乘区结算 (`_calculate_def_res`)
计算目标的防御力减损系数和抗性衰减系数。

### 第六阶段：数值合算 (`_calculate`)
执行最终的乘区公式：
```text
伤害 = (基础伤害 * 基础倍率 + 固定增伤) * 伤害加成区 * 暴击区 * 反应区 * 防御区 * 抗性区 * 独立乘区
```

### 第七阶段：结果更新
将计算得到的 `final_result` 写入 `damage.damage` 属性，并发布 `AFTER_DAMAGE` 事件。

---

## 3. 核心计算公式

### 3.1 基础伤害 (Base Damage)
通常基于“攻击力”或“生命值”，由 `scaling_stat` 指定。
- **单段**: `属性 * (倍率 / 100)`
- **多段合算**: `属性 * (sum(倍率列表) / 100)`

### 3.2 剧变反应 (Transformative Reaction)
剧变伤害（如超载、扩散）走独立计算路径：
- 基于攻击者等级对应的 `等级系数`。
- 受到元素精通的剧变加成及特定 Buff 修正。
- 仅受目标抗性影响，无视防御力和双暴。

---

## 4. 扩展与开发建议

1. **新增乘区**: 若需引入新的独立乘区，建议在 `BEFORE_CALCULATE` 事件中修改 `ctx.stats["独立乘区系数"]`。
2. **特殊缩放**: 若技能基于防御力（如阿贝多），请在技能初始化时通过 `damage.set_scaling_stat("防御力")` 指定。
3. **性能注意**: `DamagePipeline` 在高并发模拟下会频繁运行，应避免在 `BEFORE_CALCULATE` 监听器执行复杂的 IO 或循环操作。

---
*版本: V2.3.1*
*更新日期: 2026-02-12*
