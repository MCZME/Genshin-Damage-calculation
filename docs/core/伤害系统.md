# Core - 伤害系统 (Damage System)

伤害系统是仿真引擎的中枢，负责从攻击意图到最终数值结算的全流程逻辑。它采用了**流水线 (Pipeline)** 设计，确保了计算过程的标准化与高度可扩展性。

## 1. 核心概念

### 1.1 Damage 对象 (`core.action.damage.Damage`)
伤害的载体，包含了攻击的本质属性：
- **倍率 (`damage_multiplier`)**: 基础伤害百分比。
- **元素 (`element`)**: 攻击的元素类型与元素量 (Gauge)。
- **审计数据 (`data['audit_trail']`)**: 存储本次伤害的所有计算来源记录。

### 1.2 DamageContext (审计上下文)
计算过程中的上下文快照。V2.4 引入了 **“伤害审计链 (Audit Trail)”**：
- **审计接口 (`add_modifier`)**: 所有增益（Effect、面板等）必须通过此接口注入数值，严禁直接修改字典。
- **记录条目 (`ModifierRecord`)**: 包含 `source` (来源名)、`stat` (属性名)、`value` (数值) 和 `op` (加算/乘算)。

---

## 2. 伤害流水线 (DamagePipeline)

每当触发 `BEFORE_DAMAGE` 事件时，`DamageSystem` 会启动 `DamagePipeline` 执行以下阶段：

### 第一阶段：标签解析与快照 (`_snapshot`)
1. **解析分类**: 利用 `AttackTagResolver` 将 `attack_tag` 映射为 `NORMAL`, `SKILL` 等逻辑分类。
2. **属性注入**: 抓取基础面板（攻击、精通等），并通过 `add_modifier` 记录为“角色基础面板”。
3. **动态增伤区**: 根据解析分类，自动汇总对应的“普通攻击伤害加成”等数值，记录为“总和伤害加成区”。

### 第二阶段：计算前修正 (审计注入)
发布 `BEFORE_CALCULATE` 事件。
- **强制规范**: 所有 Effect 必须调用 `ctx.add_modifier(source="来源名", stat="属性", value=X)` 注入增益。
- **追溯性**: 此时注入的数值将清晰出现在最终的审计报告中。

### 第三阶段：空间广播与碰撞
对接 `CombatSpace` 执行 3D 碰撞判定。
- **高度感知**: 支持根据 Y 轴坐标判断下落攻击的触地瞬间。
- **结果**: 建立 `target` 引用并触发 ICD 判定。

### 第四阶段：反应预处理 (`_preprocess_reaction_stats`)
根据第三阶段反馈的反应结果（如增幅反应、激化），注入对应的倍率加成或固定伤害加成。

### 第五阶段：乘区结算 (`_calculate_def_res`)
计算目标的防御力减损系数和抗性衰减系数。

### 第六阶段：数值合算 (`_calculate`)
执行最终的乘区公式：
```text
伤害 = (基础伤害 * 基础倍率 + 固定增伤) * 伤害加成区 * 暴击区 * 反应区 * 防御区 * 抗性区 * 独立乘区
```

### 第七阶段：结果更新
将计算得到的 `final_result` 写入 `damage.damage` 属性，并发布 `AFTER_DAMAGE` 事件。

---

## 3. 核心计算公式

### 3.1 基础伤害 (Base Damage)
通常基于“攻击力”或“生命值”，由 `scaling_stat` 指定。
- **单段**: `属性 * (倍率 / 100)`
- **多段合算**: `属性 * (sum(倍率列表) / 100)`

### 3.2 剧变反应 (Transformative Reaction)
剧变伤害（如超载、扩散）走独立计算路径：
- 基于攻击者等级对应的 `等级系数`。
- 受到元素精通的剧变加成及特定 Buff 修正。
- 仅受目标抗性影响，无视防御力和双暴。

---

## 4. 扩展与开发建议

1. **新增增益**: 严禁直接修改 `ctx.stats`。请使用 `ctx.add_modifier(source="XX效果", stat="独立乘区系数", value=1.1, op="MULT")`。
2. **伤害追溯**: 计算完成后，可通过读取 `damage.data["audit_trail"]` 序列来调试或展示伤害构成。
3. **原生数据映射**: 确保 `data.py` 中的原生 Key 与技能装配逻辑一致，系统会自动根据 Key 生成伤害名称。

---
*版本: V2.3.1*
*更新日期: 2026-02-12*
