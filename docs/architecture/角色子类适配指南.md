# 架构设计：角色子类适配指南 (新架构 V2)

## 1. 概述
本指南确立了具体的角色子类（如香菱、夜兰等）在新版场景引擎下的模块化重构规范。

## 2. 目录结构规范 (Modular Structure)
为了提高大型角色的可维护性，必须采用以下文件布局：

```text
character/REGION/xiangling/
├── __init__.py    # 导出核心角色类
├── char.py        # 核心组装类 (继承 Character)
├── entities.py    # 战场物理实体 (锅巴、旋火轮、岩柱)
├── effects.py     # 角色特有逻辑效果 (Buff、印记、状态)
├── skills.py      # 技能逻辑 (Normal, Skill, Burst)
└── talents.py     # 固有天赋与命座定义
```

## 3. 模块职责划分

### 3.1 `entities.py` vs `effects.py`
- **Entity**：继承自 `CombatEntity`。具有 3D 位置、体积（Hitbox）和阵营。
    - *例子*：锅巴、草原核。
- **Effect**：继承自项目标准的 `Effect` 基类。通常挂载在角色的 `active_effects` 列表中，不具有空间位置。
    - *例子*：绝云朝天椒的加攻 Buff、胡桃的彼岸蝶。

## 4. 核心重构契约 (Hooks)

### 4.1 `_setup_character_components()`
**职责**：实例化技能对象与能量系统。
```python
def _setup_character_components(self):
    self.elemental_energy = ElementalEnergy(self, ('火', 80))
    self.skills = {
        "normal": NormalAttack(self.skill_params[0]),
        "skill": ElementalSkill(self.skill_params[1]),
        "burst": ElementalBurst(self.skill_params[2], self)
    }
```

### 4.2 `_setup_effects()`
**职责**：填充天赋与命座槽位。
```python
def _setup_effects(self):
    self.talents = [Talent1(), Talent2()]
    self.constellations = [C1(), C2(), C3(), C4(), C5(), C6()]
```

## 5. 关键接口规范
- **方法命名**：统一使用 **`on_frame_update()`** 作为帧驱动接口。
- **属性访问**：统一通过 **`self.skills["key"]`** 访问技能组件。
- **实体注册**：所有生成的 Entity 必须通过 **`ctx.space.register(entity)`** 进入场景。

---
*状态: 现行规范 V2.1*
*Author: Gemini CLI Agent*
*Date: 2026-02-07*
