# 架构设计：角色子类适配指南 (新架构 V2)

## 1. 概述
本指南确立了具体的角色子类（如香菱、夜兰等）在新版场景引擎下的模块化重构规范。

## 2. 目录结构规范 (Modular Structure)
必须采用以下文件布局以确保逻辑解耦：

```text
character/REGION/xiangling/
├── __init__.py    # 导出核心角色类
├── char.py        # 核心组装类 (继承 Character)
├── entities.py    # 战场物理实体 (锅巴、旋火轮、岩柱)
├── effects.py     # 角色特有逻辑效果 (Buff、印记、状态)
├── skills.py      # 技能逻辑 (Normal, Skill, Burst)
└── talents.py     # 固有天赋与命座定义
```

## 3. 复杂技能触发规范 (Parameterized Skills) [NEW]
为了支持“长按 (Hold)”、“多段 (Multi-stage)”等复杂触发逻辑，系统采用 **“参数化路由”** 模式。

### 3.1 逻辑流转
1. **角色接口层**：调用 `char.elemental_skill("长按")`。
2. **基类透传层**：`Character._get_action_data` 接收该参数。
3. **技能工厂层**：调用技能对象的 `to_action_data(params="长按")`。
4. **动作生成层**：技能对象根据参数返回具有不同帧数和判定点的 `ActionFrameData`。

### 3.2 技能实现示例 (`skills.py`)
```python
class ElementalSkill(SkillBase):
    def to_action_data(self, params: Any = None) -> ActionFrameData:
        if params == "长按":
            data = ActionFrameData(name="E_HOLD", total_frames=132, hit_frames=[111])
        else:
            data = ActionFrameData(name="E_PRESS", total_frames=42, hit_frames=[31])
        
        # 必须挂载运行时对象以维持回调
        setattr(data, "runtime_skill_obj", self)
        return data
```

## 4. 核心重构契约 (Hooks)

### 4.1 `_setup_character_components()`
**职责**：实例化技能对象与能量系统。
```python
def _setup_character_components(self):
    self.elemental_energy = ElementalEnergy(self, ('火', 80))
    self.skills = {
        "normal": NormalAttack(self.skill_params[0]),
        "skill": ElementalSkill(self.skill_params[1]),
        "burst": ElementalBurst(self.skill_params[2], self)
    }
```

### 4.2 `_setup_effects()`
**职责**：填充天赋与命座槽位。
```python
def _setup_effects(self):
    self.talents = [Talent1(), Talent2()]
    self.constellations = [C1(), C2(), C3(), C4(), C5(), C6()]
```

## 5. 关键接口规范
- **方法命名**：统一使用 **`on_frame_update()`** 作为帧驱动接口。
- **属性访问**：统一通过 **`self.skills["key"]`** 访问技能组件。
- **实体注册**：所有生成的 Entity 必须通过 **`ctx.space.register(entity)`** 进入场景。

---
*状态: 现行规范 V2.2*
*Author: Gemini CLI Agent*
*Date: 2026-02-07*