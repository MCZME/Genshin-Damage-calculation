# 架构设计：角色子类适配指南 (新架构 V2)

## 1. 概述
随着 `Character` 基类接入 `CombatEntity` 体系并引入“组件化组装”模型，所有具体的角色子类（如香菱、夜兰等）必须按照本指南进行适配重构，以确保能够在新版场景引擎中正常运行。

## 2. 核心重构契约
子类必须实现以下两个核心钩子方法，严禁在 `__init__` 中直接实例化业务组件。

### 2.1 `_setup_character_components()`
**职责**：实例化技能对象与能量系统。
**规范**：
- 必须将技能实例存入 `self.skills` 字典。
- 必须初始化 `self.elemental_energy`。

```python
def _setup_character_components(self):
    # 1. 能量系统
    self.elemental_energy = ElementalEnergy(self, ('火', 80))
    # 2. 技能组注册
    self.skills = {
        "normal": NormalAttackSkill(self.skill_params[0]),
        "skill": ElementalSkill(self.skill_params[1]),
        "burst": ElementalBurst(self.skill_params[2], self)
    }
```

### 2.2 `_setup_effects()`
**职责**：实例化角色的固有天赋与命座效果。
**规范**：
- 固有天赋存入 `self.talents` 列表（顺序对应天赋1、天赋2等）。
- 命座存入 `self.constellations` 槽位（Index 0-5 对应 1-6命）。

```python
def _setup_effects(self):
    # 填充天赋
    self.talents = [
        CrossfireEffect(), # 固有1
        ChiliPepperEffect() # 固有2
    ]
    # 填充命座槽位
    self.constellations[2] = ConstellationEffect_3() # 3命
```

## 3. 方法命名变更 (Breaking Changes)
- **驱动接口**：所有 `update()` 方法统一重命名为 **`on_frame_update()`**。
- **反射废弃**：严禁直接使用 `self.NormalAttack` 或 `self.Skill`。系统现在通过 `self.skills["skill"]` 访问组件。

## 4. 属性计算注意事项
- **不要手动修改 attribute_panel**：数值加成应通过实现 `TalentEffect` 的 `apply` 逻辑或动态 Effect 挂载来完成。
- **白值处理**：攻击力白值会自动在 `initialize_gear()` 阶段合并武器数值，无需子类干预。

## 5. 适配 checklist
- [ ] 子类继承关系是否正确。
- [ ] 是否移除了旧的 `_init_character` 方法并迁移至新钩子。

---
*状态: 现行规范*
*Author: Gemini CLI Agent*
*Date: 2026-02-07*
