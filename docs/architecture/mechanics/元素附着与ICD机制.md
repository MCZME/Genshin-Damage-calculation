# 架构设计：元素附着与ICD机制 (V2.4.1)

## 1. 元素附着模型 (Aura & Gauge)
系统严格遵循原神“附着论”，通过 `AuraManager` 和 `Gauge` 对象管理实体的元素状态。

### 1.1 元素量 (U-Value)
- **等级定义**：支持 1U、2U、4U 离散等级。
- **衰减逻辑**：
    - 附着瞬间产生 0.8x 的初始消耗（库存量）。
    - 衰减速率根据初始 U 值自动计算（9.5s / 12s / 17s 周期）。
- **特殊状态**：冻结（FROZEN）和激化（QUICKEN）拥有独立的元素量载体，支持与常规附着共存判定。

### 1.2 反应结算
- **消耗系数**：根据元素相性（如水克火 2.0x）实时计算 Gauge 扣除。
- **独立性**：反应逻辑由 `ReactionSystem` 驱动，`AuraManager` 仅负责执行底层的 Gauge 变减。

## 2. 共享 ICD 管理器 (V2.4 共享组版)
`ICDManager` 实现了跨动作、跨实体的精细化附着频率控制。

### 2.1 核心概念
- **`icd_tag` (规则标签)**：定义序列（如 `[1, 0, 0]`）和重置时间（默认 2.5s）。
- **`icd_group` (共享组)**：决定谁共用同一个计数器。
    - *示例*：角色的“普通攻击1-4”共用 `"NormalAttack"` 组，确保一套连招中只有第 1、4、7 次命中挂元素。
- **`source_id` (根源溯源)**：
    - 召唤物（如芙宁娜的沙龙成员）会自动溯源至主人 ID。
    - 确保主人与召唤物、或不同召唤物之间可以根据 `icd_group` 决定是否共享冷却。

### 2.2 附魔 (Infusion) 联动
- **属性转换**：附魔仅改变伤害的 `Element` 类型，不改变其物理动作所属的 `icd_group`。
- **逻辑一致性**：无论砍出的是物理剑还是火剑，只要属于 `"NormalAttack"` 组，其附着频率始终保持稳定。

## 3. 契约化执行流程
1. **技能产生伤害**：从 `data.py` 读取 `icd_tag` 和 `icd_group` 封装入 `AttackConfig`。
2. **附魔干预**：技能调用 `get_attack_element()` 获取当前最终元素。
3. **物理检索**：`CombatSpace` 将 `Damage` 对象广播给范围内的实体。
4. **接收判定**：实体调用 `check_attachment(icd_tag, icd_group)`。
    - 若返回 `1.0`：执行 `apply_element` 修改目标 `Aura` 并发布反应事件。
    - 若返回 `0.0`：仅造成伤害，不产生元素交互。

---
*版本: V2.4.1 (Scene-Centric & Shared ICD)*
*更新日期: 2026-02-14*
