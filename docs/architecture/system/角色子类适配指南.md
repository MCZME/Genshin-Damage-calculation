# 架构设计：角色子类适配指南 (V2.4 - 精准物理版)

## 1. 概述
本指南确立了角色子类在 V2.4 战斗仿真引擎下的重构规范。核心演进在于 **“逻辑与物理的深度解耦”**、**“精细化动作中断控制”** 以及 **“空间感知伤害判定”**。

---

## 2. 目录结构与数据解耦 (Modular Structure)
必须采用以下文件布局以实现逻辑解耦与 Registry 自动扫描：

```text
character/REGION/char_name_en/
├── __init__.py        # 注册与导出
├── char.py            # 核心编排类
├── data.py            # [自动+交互] 数据层：存放倍率、物理、机制常量
├── skills.py          # 意图 -> 动作转换逻辑
├── talents.py         # 固有天赋定义
├── constellations.py  # 命座定义
├── entities.py        # [可选] 召唤物/部署物实体
└── effects.py         # [可选] 特有状态逻辑
```

### 2.1 物理与逻辑解耦 (Decoupling)
**准则**：角色不再单独注册到物理空间，而是通过 `Team` 进行管理。
- **逻辑归 Team**：全队角色的血量、能量、Buff 状态统一通过 `self.ctx.team.get_members()` 访问。
- **物理归 Space**：在 `CombatSpace` 中，玩家阵营仅占用一个物理点（活跃点）。切换角色时，坐标（`pos`, `facing`）由 `Team` 自动同步。

### 2.2 局部配置中心 (`data.py`)
严禁在逻辑代码中硬编码数值。`data.py` 必须分为以下独立字典：
- **`BASE_STATS`**: 自动化获取的 1-100 级属性。
- **`SKILL_MULTIPLIERS`**: 高精度倍率序列。
- **`ACTION_FRAME_DATA`**: 实测时序（含 `hit_frames`, `total_frames`, `interrupt_frames`）。
- **`ATTACK_DATA`**: 攻击契约（含 Hitbox、ICD 共享组 `icd_group`、打击类型）。
- **`MECHANISM_CONFIG`**: 逻辑驱动常量（如形态切换帧、治疗频率）。

---

## 3. 标准开发流 (SOP v2.4)

### 第一阶段：自动化获取与基础验证 (Base)
1.  运行 `fetch_content.py` 自动生成属性与倍率。
2.  **[人工确认]** 核对 `data.py` 中的数值准确性。

### 第二阶段：物理数据交互录入 (Physics)
1.  将实测 CSV 中的帧数、中断窗口及碰撞范围录入 `data.py` 的对应字典。
2.  **[人工确认]** 确认物理转译（形状尺寸、偏移、ICD 共享组）正确。

### 第三阶段：组件化迭代开发 (Implementation)
1.  **组件化实现**：按实体 -> 效果 -> 技能顺序分块实现。
2.  **伤害审计对接**：增益注入严禁修改 `stats` 字典，必须通过 `ctx.add_modifier(source, stat, value)`。
3.  **[人工确认]** 获得授权后方可进入下一块。

### 第四阶段：总装与质量验证 (Verification)
1.  在 `char.py` 中挂载组件，使用 `Simulator` 运行测试序列并审计 `EventFlow` 日志。

---

## 4. 核心重构契约 (Initialization Hooks)

### 4.1 构造函数规范 (Constructor Hygiene)
**强制禁令**：
1. **严禁使用 `**kwargs`**：所有参数（`id`, `level`, `skill_params`, `constellation`, `base_data`）必须显式声明并透传。
2. **严禁手动构造 `base_data`**：角色类仅负责逻辑编排，不负责准备初始数据。数据应由 `TeamFactory` 或测试环境传入。
3. **正确继承**：必须优先继承所属区域的基类（如 `Region/REGION/region.py`），以确保自动获得该地区的通用机制（如枫丹角色的“荒芒”属性 `self.arkhe`）。

### 4.2 `_setup_character_components()`
**职责**：实例化技能对象与能量系统。
**原子化原则**：严禁在普攻组件中混写重击逻辑。
```python
def _setup_character_components(self):
    self.skills = {
        "normal": FurinaNormalAttack(self.skill_params[0], self),
        "charged": FurinaChargedAttack(self.skill_params[0], self), # 物理分离
        "plunge": FurinaPlungingAttack(self.skill_params[0], self), # 物理分离
        "skill": FurinaElementalSkill(self.skill_params[1], self),
        "burst": FurinaElementalBurst(self.skill_params[2], self),
        "dash": DashSkill(caster=self), # 挂载通用移动组件
        "jump": JumpSkill(caster=self)
    }
```

### 4.2 `_setup_effects()`
**职责**：填充天赋与命座列表。
```python
def _setup_effects(self):
    self.talents = [Passive1(), Passive2()]
    self.constellations = [C1(), C2(), None, C4(), None, C6()] # 支持占位
```

---

## 5. 意图驱动与动作生成 (Intent-Driven)

### 5.1 精准动作工厂化 (`skills.py`)
技能类必须实现 `to_action_data(intent)` 接口，执行物理与时序的“手工装配”：

```python
class ElementalSkill(SkillBase):
    def to_action_data(self, intent: dict = None) -> ActionFrameData:
        # 1. 提取实测数据 (保持原生中文映射)
        frames = ACTION_FRAME_DATA["SKILL_PRESS"]
        physics = ATTACK_DATA["元素战技"] # 使用字典 Key 作为识别名
        
        return ActionFrameData(
            name="元素战技",
            total_frames=frames["total_frames"],
            hit_frames=frames["hit_frames"],
            interrupt_frames=frames["interrupt_frames"],
            attack_config=AttackConfig(
                attack_tag=physics["attack_tag"],
                icd_group=physics["icd_group"],
                # 执行形状映射：'球' -> AOEShape.SPHERE
                hitbox=HitboxConfig(shape=self._map_shape(physics["shape"]), ...)
            )
        )
```

---

## 6. 元数据发现机制 (Metadata Discovery)
UI 通过类方法感知参数 Schema，实现无码化渲染。详见角色主类 `get_action_metadata()` 的实现标准。

---

## 7. 关键原则总结
1.  **空间广播**：禁止在技能中寻找 `target`，应发布 `BEFORE_DAMAGE` 事件，由系统执行范围判定。
2.  **去物理化**：UI 仅传输逻辑意图（Intent），物理表现由 `data.py` 与 `ASM` 共同决定。
3.  **注册规范**：统一使用英文标识名 (route) 作为目录名，中文名用于 Registry 注册。
4.  **物理高度感知**：对于下落攻击等特殊动作，必须在 `on_frame_update` 中进行 Y 轴监测，落地判定由物理位置驱动而非定时帧。
5.  **标准化辅助动作**：所有角色应挂载 `SkipSkill`（Key 为 `skip`），用于在旋转编排中模拟等待与空闲帧。

---
*版本: V2.4 (SOP & Precise Physics)*
*更新日期: 2026-02-12*
