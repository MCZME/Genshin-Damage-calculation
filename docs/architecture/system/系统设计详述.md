# 原神伤害计算器 - 系统设计详述 (V2.4)

## 1. 伤害计算体系 (DamagePipeline)

### 1.1 伤害审计机制 (Damage Audit Trail)
V2.4 引入了强制性的审计机制。`DamageContext` 不再只是一个数值容器，而是一个带有“来源记录”的账本。
*   **审计接口**: 所有数值修改必须调用 `ctx.add_modifier(source, stat, value, op)`。
*   **透明度**: 每一笔伤害都持有完整的 `audit_trail` 序列，记录了从角色面板到最终暴击判定的所有贡献因素。

### 1.2 执行阶段 (Execution Phases)
1.  **附魔处理**: 决定普攻/重击/下落的元素属性。
2.  **标签解析与快照 (`_snapshot`)**: 
    *   利用 `AttackTagResolver` 将 `attack_tag` 映射为逻辑分类（如 `NORMAL`, `SKILL`）。
    *   根据分类动态从面板提取对应的“普通攻击伤害加成”等数值，并通过审计接口记录为“总和伤害加成区”。
3.  **计算前修正 (Event-Driven)**: 发布 `BEFORE_CALCULATE` 事件。Effect 必须在此阶段注入外部增益。
4.  **空间广播与受击**: 调用 `CombatSpace` 进行几何检索。
5.  **数值合算**: 汇总所有审计条目，执行防御、抗性、暴击及独立乘区的乘算。

## 2. 空间与物理系统 (CombatSpace)

### 2.1 3D 碰撞判定
伤害广播支持完整的 X, Y, Z 空间判定：
*   **高度感知**: 角色和攻击判定具有真实的垂直坐标。
*   **物理触发**: 下落攻击的“落地冲击”命中点不再由帧数预定，而是由物理触地瞬间 (Y <= 0) 动态触发。

### 2.2 位移与同步
*   **自驱动位移**: 角色执行冲刺或特定技能动作时，坐标直接在 `advance_frame` 中更新。
*   **物理分层**: 目前主要处理伤害广播判定，暂不涉及实体间的刚体挤压。

## 3. 动作状态机引擎 (ActionManager)

### 3.1 核心机制
每个角色持有一个 `ActionManager`，负责维护角色的“忙碌”状态。
*   **`ActionInstance`**: 代表一个具体的动作执行过程，记录已流逝帧数和待触发的判定帧（`hit_frames`）。
*   **取消窗口 (Cancel Window)**: 允许在特定帧后通过切换动作来中断当前动作的后摇。
*   **回调机制**: 动作执行完成后，通过 `origin_skill` 触发后续逻辑。

## 4. 元素附着理论 (Aura Theory V2.4)

### 4.1 原生 ICD 管理
V2.4 实现了基于 **“零翻译”原生标签** 的全局 ICD 控制。
*   **原生映射**: ICD 标签（如 `FurinaElementalSkill`）直接从 `data.py` 中的 `icd_tag` 字段索引，保持与实测 CSV 完全一致。
*   **重置规则**: 遵循 2.5s / 3 次打击重置的通用规则，支持序列长度感知的动态附着。

### 4.2 反应映射
`ReactionSystem` 建立了一套完整的反应优先级矩阵，确保在多元素环境下（如雷草水）反应触发的确定性。

---
*版本: v2.5.0*
*更新日期: 2026-02-13*
