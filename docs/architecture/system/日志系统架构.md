# 架构设计：高保真日志系统 (V2.1 - 结构化与流式版)

## 1. 设计目标
日志系统不仅是调试工具，更是仿真引擎的 **“神经反馈”**。V2.1 版本旨在实现：
*   **结构化输出**: 从纯字符串转向对象/字典，支持 UI 分离渲染图标、颜色与数值。
*   **多端消费 (Multi-Sink)**: 同步支持文件、控制台、SQLite 快照以及 UI 实时滚动窗。
*   **上下文隔离**: 确保在批处理（多进程）模式下，各仿真实例的日志互不干扰。
*   **帧感知 (Frame-Aware)**: 所有日志强制携带 `frame_id`，实现与战斗时间轴的精准对齐。

---

## 2. 核心组件

### 2.1 `LogEvent` (数据载体)
日志不再只是消息，而是一个事件对象：
```python
{
    "frame": 120,
    "level": "DAMAGE",
    "source": "香菱",
    "target": "遗迹守卫",
    "payload": {
        "action": "旋火轮",
        "value": 15400,
        "element": "火",
        "reaction": "蒸发"
    },
    "message": "🔥 香菱使用 旋火轮 对遗迹守卫 造成 15400 点 火 伤害 (蒸发)"
}
```

### 2.2 `SimulationLogger` (生产者)
绑定于 `SimulationContext` 的日志管理器。
*   **实例模式**: 每一个 `Simulator` 实例持有一个独立的 Logger。
*   **业务钩子**: 提供 `log_damage`, `log_reaction`, `log_energy` 等语义化接口。

### 2.3 `UIHandler` (消费者)
NiceGUI 专用的日志拦截器。
*   **Circular Buffer**: 在内存中维护一个有限长度（如 500 条）的循环缓冲区。
*   **推送机制**: 通过信号或定时器将缓冲区内容同步至前端 `ui.log` 控件。

---

## 3. 日志等级与优先级 (Custom Levels)

| 等级名称 | 数值 | 用途 | UI 建议颜色 |
| :--- | :--- | :--- | :--- |
| `DAMAGE` | 25 | 伤害结算 | 红色 (火)/蓝色 (水) 等元素色 |
| `HEAL` | 26 | 治疗反馈 | 绿色 |
| `REACTION` | 28 | 元素反应触发 | 金色/紫色 |
| `ENERGY` | 27 | 能量获取 | 浅蓝色 |
| `EFFECT` | 29 | Buff 挂载/消失 | 灰色/半透明 |
| `OBJECT` | 31 | 召唤物/部署物状态 | 白色 |

---

## 4. 批处理模式下的隔离设计

在执行 **批量仿真 (Batch Processing)** 时，日志系统采取以下策略：
1.  **进程私有化**: 每个子进程创建独立的 `logging.Logger` 实例。
2.  **静默模式**: 批处理时通常关闭 `StreamHandler` (控制台) 和 `UIHandler`，仅保留 `SQLiteHandler` 以供后续汇总统计。
3.  **聚合收集**: 主进程通过 `multiprocessing.Queue` 收集子进程的异常日志。

---

## 5. 接入规范 (Implementation)

### 5.1 生产者调用
禁止直接使用 `print()`。在 System 逻辑中必须通过 Context 获取 Logger：
```python
from core.logger import get_emulation_logger

logger = get_emulation_logger()
logger.log_damage(source, target, damage_obj)
```

### 5.2 UI 实时绑定
在 UI 页面启动仿真时，动态注入拦截器：
```python
# PrototypeState.py
async def run_simulation(self):
    # 这里的 handler 会将日志实时 push 到 ui_buffer
    handler = UIInternalHandler(self.ui_log_widget)
    simulator.logger.add_handler(handler)
    ...
```

---
*版本: V2.1 (Structured Logging)*
*日期: 2026-02-09*
